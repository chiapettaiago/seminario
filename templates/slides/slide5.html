{% extends "base.html" %}

{% block title %}ExercÃ­cio Interativo: Simple Past{% endblock %}

{% block content %}
<h2><i class="fas fa-clock"></i> ExercÃ­cio Interativo: Simple Past</h2>

<div style="text-align: left; width: 100%;">
    <div style="background: rgba(255, 107, 107, 0.03); border-left: 4px solid #FF6B6B; padding: 1.5rem; margin-bottom: 2rem; border-radius: 0 8px 8px 0; animation: fadeIn 1s ease-out;">
        <p style="margin-bottom: 1rem; font-size: 1.1rem; color: white;">
            <strong>ðŸ‡§ðŸ‡· Simple Past:</strong> Usado para aÃ§Ãµes que <strong>aconteceram</strong> e <strong>terminaram</strong> no passado.
            Exemplo: "Eu <strong>estudei</strong> inglÃªs ontem" / "I <strong>studied</strong> English yesterday"
        </p>
        <p style="margin-bottom: 0; font-size: 1.1rem; color: white;">
            <strong>ðŸ‡ºðŸ‡¸ Simple Past:</strong> Used for actions that <strong>happened</strong> and <strong>finished</strong> in the past.
            Example: "I <strong>studied</strong> English yesterday" / "We <strong>built</strong> this app last year"
        </p>
    </div>

    <div class="interactive-exercise" style="background: #252830; color: #f7f9fc;">
        <h3 style="color: #FF6B6B; margin-bottom: 1rem;"><i class="fas fa-puzzle-piece"></i> Complete as frases no Simple Past:</h3>
        <p style="font-size: 1rem; margin: 1rem 0; color: #87CEEB;" id="exercise-instructions">
            <i class="fas fa-hand-point-right"></i> <span class="desktop-instruction">Arraste a forma correta do verbo para completar cada frase:</span><span class="mobile-instruction" style="display: none;"><strong>Mobile:</strong> Toque na palavra, depois toque na Ã¡rea de resposta. Ou arraste diretamente!</span>
        </p>
        
        <!-- ExercÃ­cio 1 -->
        <div style="background: #2f333d; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0;">
            <p style="font-size: 1.2rem; margin: 1rem 0; color: #FFD700;">
                <strong>1.</strong> "Yesterday, I _____ a new programming language."
            </p>
            
            <div class="drag-drop-area">
                <div class="draggable-word" draggable="true" data-word="learned" data-exercise="1">learned</div>
                <div class="draggable-word" draggable="true" data-word="learn" data-exercise="1">learn</div>
                <div class="draggable-word" draggable="true" data-word="learning" data-exercise="1">learning</div>
            </div>
            
            <div class="drop-zone" id="answer-zone-1" data-correct="learned">
                Arraste a resposta aqui
            </div>
            
            <div id="feedback-1" style="margin-top: 1rem; font-weight: 600;"></div>
        </div>

        <!-- ExercÃ­cio 2 -->
        <div style="background: #2f333d; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0;">
            <p style="font-size: 1.2rem; margin: 1rem 0; color: #FFD700;">
                <strong>2.</strong> "The team _____ the project last month."
            </p>
            
            <div class="drag-drop-area">
                <div class="draggable-word" draggable="true" data-word="finished" data-exercise="2">finished</div>
                <div class="draggable-word" draggable="true" data-word="finish" data-exercise="2">finish</div>
                <div class="draggable-word" draggable="true" data-word="finishes" data-exercise="2">finishes</div>
            </div>
            
            <div class="drop-zone" id="answer-zone-2" data-correct="finished">
                Arraste a resposta aqui
            </div>
            
            <div id="feedback-2" style="margin-top: 1rem; font-weight: 600;"></div>
        </div>

        <!-- ExercÃ­cio 3 -->
        <div style="background: #2f333d; padding: 1.5rem; border-radius: 12px; margin: 1.5rem 0;">
            <p style="font-size: 1.2rem; margin: 1rem 0; color: #FFD700;">
                <strong>3.</strong> "She _____ to the office by bus."
            </p>
            
            <div class="drag-drop-area">
                <div class="draggable-word" draggable="true" data-word="went" data-exercise="3">went</div>
                <div class="draggable-word" draggable="true" data-word="go" data-exercise="3">go</div>
                <div class="draggable-word" draggable="true" data-word="goes" data-exercise="3">goes</div>
            </div>
            
            <div class="drop-zone" id="answer-zone-3" data-correct="went">
                Arraste a resposta aqui
            </div>
            
            <div id="feedback-3" style="margin-top: 1rem; font-weight: 600;"></div>
        </div>

        <div style="background: rgba(76, 175, 80, 0.1); border: 2px solid #4CAF50; border-radius: 12px; padding: 1.5rem; margin: 2rem 0; text-align: center;">
            <h3 style="color: #4CAF50; margin-bottom: 1rem;"><i class="fas fa-lightbulb"></i> Dicas do Simple Past:</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div>
                    <p style="font-size: 0.9rem; margin: 0;"><strong>Verbos Regulares:</strong><br>work â†’ work<strong>ed</strong></p>
                </div>
                <div>
                    <p style="font-size: 0.9rem; margin: 0;"><strong>Verbos Irregulares:</strong><br>go â†’ <strong>went</strong></p>
                </div>
                <div>
                    <p style="font-size: 0.9rem; margin: 0;"><strong>Palavras-chave:</strong><br>yesterday, last, ago</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
// Enhanced drag and drop functionality with mobile touch support for Simple Past exercise
function setupDragAndDrop() {
    const draggables = document.querySelectorAll('.draggable-word');
    const dropZones = document.querySelectorAll('.drop-zone');
    let draggedElement = null;
    let touchOffset = { x: 0, y: 0 };
    let isDragging = false;
    
    // Detect if device supports touch
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    
    draggables.forEach(draggable => {
        // Desktop drag events
        draggable.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.word);
            e.dataTransfer.setData('exercise', e.target.dataset.exercise);
            e.target.style.opacity = '0.6';
            e.target.classList.add('dragging');
            draggedElement = e.target;
        });
        
        draggable.addEventListener('dragend', (e) => {
            e.target.style.opacity = '1';
            e.target.classList.remove('dragging');
            draggedElement = null;
        });
        
        // Mobile touch events
        if (isTouchDevice) {
            draggable.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDragging = true;
                draggedElement = e.target;
                
                const touch = e.touches[0];
                const rect = e.target.getBoundingClientRect();
                touchOffset.x = touch.clientX - rect.left;
                touchOffset.y = touch.clientY - rect.top;
                
                // Visual feedback
                e.target.style.opacity = '0.8';
                e.target.classList.add('dragging');
                e.target.style.zIndex = '1000';
                e.target.style.position = 'relative';
                
                // Add vibration feedback if available
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }, { passive: false });
            
            draggable.addEventListener('touchmove', (e) => {
                if (!isDragging || !draggedElement) return;
                e.preventDefault();
                
                const touch = e.touches[0];
                const x = touch.clientX - touchOffset.x;
                const y = touch.clientY - touchOffset.y;
                
                // Move the element
                draggedElement.style.transform = `translate(${x - draggedElement.offsetLeft}px, ${y - draggedElement.offsetTop}px) scale(1.1)`;
                
                // Check if over drop zone
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const dropZone = elementBelow?.closest('.drop-zone');
                
                // Remove previous hover states
                dropZones.forEach(zone => zone.classList.remove('drag-over'));
                
                if (dropZone) {
                    dropZone.classList.add('drag-over');
                }
            }, { passive: false });
            
            draggable.addEventListener('touchend', (e) => {
                if (!isDragging || !draggedElement) return;
                e.preventDefault();
                
                const touch = e.changedTouches[0];
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const dropZone = elementBelow?.closest('.drop-zone');
                
                // Reset element position and style
                draggedElement.style.transform = '';
                draggedElement.style.opacity = '1';
                draggedElement.style.zIndex = '';
                draggedElement.style.position = '';
                draggedElement.classList.remove('dragging');
                
                // Remove hover states
                dropZones.forEach(zone => zone.classList.remove('drag-over'));
                
                if (dropZone) {
                    const word = draggedElement.dataset.word;
                    const exercise = draggedElement.dataset.exercise;
                    const dropZoneId = dropZone.id;
                    const expectedExercise = dropZoneId.split('-')[2];
                    
                    if (exercise === expectedExercise) {
                        handleWordDrop(word, dropZone);
                        
                        // Success vibration
                        if (navigator.vibrate) {
                            navigator.vibrate([100, 50, 100]);
                        }
                    }
                }
                
                isDragging = false;
                draggedElement = null;
            }, { passive: false });
        }
        
        // Click/tap alternative for mobile
        draggable.addEventListener('click', function() {
            if (isTouchDevice) {
                this.classList.add('selected');
                
                // Remove selection from other words in the same exercise
                const exerciseNum = this.dataset.exercise;
                const otherWords = document.querySelectorAll(`[data-exercise="${exerciseNum}"]`);
                otherWords.forEach(word => {
                    if (word !== this) {
                        word.classList.remove('selected');
                    }
                });
                
                // Update drop zone text to show it's ready for selection
                const dropZone = document.getElementById(`answer-zone-${exerciseNum}`);
                if (dropZone && !dropZone.innerHTML.includes('âœ“') && !dropZone.innerHTML.includes('âœ—')) {
                    dropZone.innerHTML = `Toque aqui para usar "${this.dataset.word}"`;
                    dropZone.dataset.pendingWord = this.dataset.word;
                }
            }
        });
    });
    
    dropZones.forEach(dropZone => {
        // Desktop drop events
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', (e) => {
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            const word = e.dataTransfer.getData('text/plain');
            const exercise = e.dataTransfer.getData('exercise');
            const dropZoneId = dropZone.id;
            const expectedExercise = dropZoneId.split('-')[2];
            
            if (exercise === expectedExercise) {
                handleWordDrop(word, dropZone);
            }
            dropZone.classList.remove('drag-over');
        });
        
        // Mobile tap alternative
        if (isTouchDevice) {
            dropZone.addEventListener('click', function() {
                const pendingWord = this.dataset.pendingWord;
                if (pendingWord) {
                    handleWordDrop(pendingWord, this);
                    this.removeAttribute('data-pending-word');
                    
                    // Clear selection
                    const exerciseNum = this.id.split('-')[2];
                    const selectedWord = document.querySelector(`[data-exercise="${exerciseNum}"].selected`);
                    if (selectedWord) {
                        selectedWord.classList.remove('selected');
                    }
                }
            });
        }
    });
}

function handleWordDrop(word, dropZone) {
    const correctAnswer = dropZone.dataset.correct;
    const exerciseNum = dropZone.id.split('-')[2];
    const feedback = document.getElementById(`feedback-${exerciseNum}`);
    
    if (word === correctAnswer) {
        dropZone.innerHTML = `<strong style="color: #4CAF50; font-size: 1.3rem;">${word} âœ“</strong>`;
        dropZone.classList.add('correct');
        feedback.innerHTML = '<span style="color: #4CAF50; font-size: 1.1rem;"><i class="fas fa-check-circle"></i> Perfeito! VocÃª dominou o Simple Past!</span>';
        feedback.style.animation = 'slideInUp 0.6s ease-out';
        
        // Play success sound (if available)
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance('Correct!');
            utterance.lang = 'en-US';
            utterance.volume = 0.3;
            speechSynthesis.speak(utterance);
        }
        
        // Confetti effect for mobile
        createConfettiEffect(dropZone);
    } else {
        dropZone.innerHTML = `<strong style="color: #f44336; font-size: 1.3rem;">${word} âœ—</strong>`;
        dropZone.classList.add('incorrect');
        
        let hint = '';
        if (exerciseNum === '1') {
            hint = 'Dica: "Yesterday" indica passado. Use "learned"!';
        } else if (exerciseNum === '2') {
            hint = 'Dica: "Last month" Ã© passado. Use "finished"!';
        } else if (exerciseNum === '3') {
            hint = 'Dica: Verbo irregular "go" â†’ "went" no passado!';
        }
        
        feedback.innerHTML = `<span style="color: #f44336; font-size: 1rem;"><i class="fas fa-times-circle"></i> Tente novamente! ${hint}</span>`;
        feedback.style.animation = 'shake 0.5s ease-out';
        
        // Reset drop zone after 3 seconds
        setTimeout(() => {
            dropZone.innerHTML = 'Arraste a resposta aqui';
            dropZone.classList.remove('incorrect');
            feedback.innerHTML = '';
        }, 3000);
    }
}

// Confetti effect for success
function createConfettiEffect(element) {
    const colors = ['#FFD700', '#FF6B6B', '#4CAF50', '#87CEEB', '#FFA500'];
    
    for (let i = 0; i < 20; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.style.cssText = `
                position: absolute;
                width: 10px;
                height: 10px;
                background: ${colors[Math.floor(Math.random() * colors.length)]};
                pointer-events: none;
                z-index: 9999;
                border-radius: 50%;
                left: ${element.offsetLeft + element.offsetWidth / 2}px;
                top: ${element.offsetTop}px;
                animation: confetti-fall 2s ease-out forwards;
            `;
            
            document.body.appendChild(confetti);
            
            setTimeout(() => {
                confetti.remove();
            }, 2000);
        }, i * 50);
    }
}

// Add confetti animation
const confettiStyle = document.createElement('style');
confettiStyle.textContent = `
    @keyframes confetti-fall {
        0% {
            transform: translateY(0) rotate(0deg);
            opacity: 1;
        }
        100% {
            transform: translateY(200px) rotate(360deg);
            opacity: 0;
        }
    }
    
    @keyframes slideInUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    .draggable-word.selected {
        background: #FF6B6B !important;
        color: white !important;
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
    }
    
    /* Mobile-specific styles */
    @media (max-width: 768px) {
        .drag-drop-area {
            margin: 1.5rem 0;
        }
        
        .draggable-word {
            margin: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .drop-zone {
            font-size: 1.1rem;
            line-height: 1.4;
        }
    }
`;
document.head.appendChild(confettiStyle);

// Add mobile-specific instructions
function addMobileInstructions() {
    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    
    if (isTouchDevice) {
        const desktopInstruction = document.querySelector('.desktop-instruction');
        const mobileInstruction = document.querySelector('.mobile-instruction');
        
        if (desktopInstruction && mobileInstruction) {
            desktopInstruction.style.display = 'none';
            mobileInstruction.style.display = 'inline';
        }
        
        // Add visual indicator for mobile users
        const exerciseDiv = document.querySelector('.interactive-exercise');
        if (exerciseDiv) {
            const mobileHint = document.createElement('div');
            mobileHint.innerHTML = `
                <div style="background: rgba(255, 107, 107, 0.1); border: 2px solid #FF6B6B; border-radius: 12px; padding: 1rem; margin: 1rem 0; text-align: center;">
                    <p style="margin: 0; color: #FF6B6B; font-weight: 600;">
                        ðŸ“± <strong>Modo Touch Ativado!</strong><br>
                        <span style="font-size: 0.9rem;">â€¢ Toque na palavra para selecionÃ¡-la<br>
                        â€¢ Toque na Ã¡rea cinza para colocar a resposta<br>
                        â€¢ Ou arraste diretamente com o dedo</span>
                    </p>
                </div>
            `;
            exerciseDiv.insertBefore(mobileHint, exerciseDiv.firstChild.nextSibling);
        }
    }
}

// Initialize drag and drop when page loads
document.addEventListener('DOMContentLoaded', () => {
    setupDragAndDrop();
    addMobileInstructions();
});
{% endblock %}
